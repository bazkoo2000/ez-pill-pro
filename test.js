javascript:(function(){
  'use strict';
  const PANEL_ID = 'ali_sys_v4';
  const VERSION = '4.9';
  const VER_KEY = 'ezpill_ver';
  if (document.getElementById(PANEL_ID)) { document.getElementById(PANEL_ID).remove(); return; }
  const state = { savedRows:[], visitedSet:new Set(), isProcessing:false, isSyncing:false, openedCount:0, tbody:null, noNewStreak:0 };
  const IOS = { bg:'rgba(243,244,246,0.92)', card:'#ffffff', border:'rgba(0,0,0,0.04)', text:'#1f2937', muted:'#9ca3af', accent:'#6366f1', accent2:'#818cf8', success:'#22c55e', error:'#ef4444', warn:'#f59e0b', shadow:'0 1px 2px rgba(0,0,0,0.03),0 0 0 0.5px rgba(0,0,0,0.03)', font:'-apple-system,BlinkMacSystemFont,Segoe UI,Cairo,Helvetica,sans-serif' };

  function showToast(msg,type){
    type=type||'info';var c=document.getElementById('ali-toast-box');
    if(!c){c=document.createElement('div');c.id='ali-toast-box';c.style.cssText='position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:99999999;display:flex;flex-direction:column-reverse;gap:8px;align-items:center';document.body.appendChild(c)}
    var cl={success:'#22c55e',error:'#ef4444',warning:'#f59e0b',info:'#6366f1'};var ic={success:'âœ…',error:'âŒ',warning:'âš ï¸',info:'â„¹ï¸'};
    var t=document.createElement('div');t.style.cssText='background:'+IOS.card+';color:'+cl[type]+';padding:12px 22px;border-radius:14px;font-size:13px;font-weight:700;font-family:'+IOS.font+';box-shadow:0 8px 30px rgba(0,0,0,0.1);display:flex;align-items:center;gap:8px;direction:rtl;animation:aliToastIn 0.4s cubic-bezier(0.16,1,0.3,1)';
    t.innerHTML='<span>'+ic[type]+'</span> '+msg;c.appendChild(t);
    setTimeout(function(){t.style.transition='all 0.3s';t.style.opacity='0';t.style.transform='translateY(10px)';setTimeout(function(){t.remove()},300)},3500);
  }
  try{var lv=localStorage.getItem(VER_KEY);if(lv!==VERSION){localStorage.setItem(VER_KEY,VERSION);if(lv)setTimeout(function(){showToast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ù€ v'+VERSION+' â€” iOS Design ğŸ“±','success')},1000)}}catch(e){}

  function showDialog(opts){
    return new Promise(function(resolve){
      var ov=document.createElement('div');ov.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.25);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);z-index:99999999;display:flex;align-items:center;justify-content:center;animation:aliFadeIn 0.2s';
      var infoH='';if(opts.info&&opts.info.length){for(var i=0;i<opts.info.length;i++){var r=opts.info[i];infoH+='<div style="display:flex;justify-content:space-between;align-items:center;padding:13px 16px;background:'+IOS.bg+';border-radius:12px;margin-bottom:6px"><span style="font-size:13px;color:'+IOS.muted+';font-weight:600">'+r.label+'</span><span style="font-weight:800;color:'+(r.color||IOS.accent)+';font-size:14px">'+r.value+'</span></div>'}}
      var badH='';if(opts.badges&&opts.badges.length){badH='<div style="display:flex;justify-content:center;flex-wrap:wrap;gap:6px;padding:4px 0 8px">';for(var b=0;b<opts.badges.length;b++){var bg=opts.badges[b];var bs=bg.active?'color:'+IOS.accent+';background:rgba(99,102,241,0.08)':'color:'+IOS.muted+';background:'+IOS.bg;badH+='<span style="padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;'+bs+'">'+bg.text+'</span>'}badH+='</div>'}
      var btnH='';if(opts.buttons&&opts.buttons.length){for(var j=0;j<opts.buttons.length;j++){var bt=opts.buttons[j];var bc=bt.primary?'background:'+IOS.accent+';color:white;font-weight:800':'background:rgba(0,0,0,0.04);color:'+IOS.muted+';font-weight:700';btnH+='<button data-idx="'+j+'" style="flex:1;padding:14px;border:none;border-radius:12px;cursor:pointer;font-size:15px;font-family:'+IOS.font+';transition:all 0.2s;'+bc+'">'+bt.text+'</button>'}}
      ov.innerHTML='<div style="background:'+IOS.card+';border-radius:20px;width:380px;max-width:90vw;overflow:hidden;font-family:'+IOS.font+';direction:rtl;color:'+IOS.text+';box-shadow:0 20px 60px rgba(0,0,0,0.12);animation:aliDialogIn 0.35s cubic-bezier(0.16,1,0.3,1)"><div style="padding:28px 24px 0;text-align:center"><div style="width:64px;height:64px;border-radius:18px;background:rgba(99,102,241,0.06);display:flex;align-items:center;justify-content:center;font-size:28px;margin:0 auto 14px">'+opts.icon+'</div><div style="font-size:18px;font-weight:800;margin-bottom:6px">'+opts.title+'</div><div style="font-size:13px;color:'+IOS.muted+';line-height:1.7">'+opts.desc+'</div></div>'+badH+'<div style="padding:16px 24px">'+infoH+(opts.body||'')+'</div><div style="padding:6px 24px 24px;display:flex;gap:10px">'+btnH+'</div></div>';
      ov.addEventListener('click',function(e){var el=e.target.closest('[data-idx]');if(el){var idx=parseInt(el.getAttribute('data-idx'));ov.style.transition='opacity 0.2s';ov.style.opacity='0';setTimeout(function(){ov.remove()},200);resolve(opts.buttons[idx].value)}});
      document.body.appendChild(ov);
    });
  }

  var styleEl=document.createElement('style');styleEl.id='ali-pro-css';
  styleEl.innerHTML=
    '@keyframes aliSlideIn{from{opacity:0;transform:translateX(40px) scale(0.97)}to{opacity:1;transform:translateX(0) scale(1)}}'+
    '@keyframes aliPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}'+
    '@keyframes aliSpin{to{transform:rotate(360deg)}}'+
    '@keyframes aliFadeIn{from{opacity:0}to{opacity:1}}'+
    '@keyframes aliDialogIn{from{opacity:0;transform:scale(0.95) translateY(12px)}to{opacity:1;transform:scale(1) translateY(0)}}'+
    '@keyframes aliToastIn{from{opacity:0;transform:translateY(20px) scale(0.95)}to{opacity:1;transform:translateY(0) scale(1)}}'+
    '@keyframes aliCountUp{from{transform:scale(1.3);opacity:0.5}to{transform:scale(1);opacity:1}}'+
    '@keyframes aliBlink{0%,100%{opacity:1}50%{opacity:0.4}}'+
    '@keyframes aliFadeTab{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}'+
    '#'+PANEL_ID+'{position:fixed;top:14px;right:14px;width:380px;max-height:92vh;background:'+IOS.bg+';backdrop-filter:blur(40px);-webkit-backdrop-filter:blur(40px);border-radius:22px;border:1px solid rgba(255,255,255,0.5);box-shadow:0 20px 60px rgba(0,0,0,0.1),0 0 0 0.5px rgba(0,0,0,0.05);z-index:9999999;font-family:'+IOS.font+';direction:rtl;color:'+IOS.text+';overflow:hidden;transition:all 0.4s cubic-bezier(0.16,1,0.3,1);animation:aliSlideIn 0.5s cubic-bezier(0.16,1,0.3,1)}'+
    '#'+PANEL_ID+'.ali-minimized{width:56px!important;height:56px!important;border-radius:50%!important;cursor:pointer!important;background:linear-gradient(135deg,#6366f1,#8b5cf6)!important;box-shadow:0 8px 24px rgba(99,102,241,0.3)!important;animation:aliPulse 2s infinite;overflow:hidden}'+
    '#'+PANEL_ID+'.ali-minimized .ali-inner{display:none!important}'+
    '#'+PANEL_ID+'.ali-minimized::after{content:"ğŸ”";font-size:22px;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}'+
    '#'+PANEL_ID+' .ios-grp{background:'+IOS.card+';border-radius:14px;overflow:hidden;box-shadow:'+IOS.shadow+';margin-bottom:12px}'+
    '#'+PANEL_ID+' .ios-item{display:flex;align-items:center;gap:12px;padding:13px 16px;border-bottom:0.5px solid #f3f4f6;transition:background 0.15s}'+
    '#'+PANEL_ID+' .ios-item:last-child{border-bottom:none}'+
    '#'+PANEL_ID+' .ios-item:hover{background:#f9fafb}'+
    '#'+PANEL_ID+' .ios-btn{width:100%;padding:14px;border:none;border-radius:12px;cursor:pointer;font-weight:800;font-size:14px;font-family:'+IOS.font+';transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:8px}'+
    '#'+PANEL_ID+' .ios-btn:active{transform:scale(0.98);opacity:0.9}'+
    '#'+PANEL_ID+' .ios-primary{background:'+IOS.accent+';color:white}'+
    '#'+PANEL_ID+' .ios-success{background:'+IOS.success+';color:white}'+
    '#'+PANEL_ID+' .ios-ghost{background:rgba(0,0,0,0.03);color:'+IOS.muted+'}'+
    '#'+PANEL_ID+' .ios-input{width:100%;padding:12px 16px;border:none;border-radius:12px;font-size:14px;font-family:'+IOS.font+';outline:none;background:rgba(0,0,0,0.03);color:'+IOS.text+';transition:all 0.2s;font-weight:600;box-sizing:border-box}'+
    '#'+PANEL_ID+' .ios-input:focus{background:rgba(99,102,241,0.04);box-shadow:0 0 0 2px rgba(99,102,241,0.15)}'+
    '#'+PANEL_ID+' .ios-input.match{background:rgba(34,197,94,0.04);box-shadow:0 0 0 2px rgba(34,197,94,0.15)}'+
    '#'+PANEL_ID+' .ios-input.nomatch{background:rgba(239,68,68,0.04);box-shadow:0 0 0 2px rgba(239,68,68,0.15)}';
  document.head.appendChild(styleEl);

  var calculatedPages=10;try{var targetText='ready to pack';var loc=window.location.href.toLowerCase();if(loc.indexOf('new')!==-1)targetText='new orders';else if(loc.indexOf('packed')!==-1&&loc.indexOf('ready')===-1)targetText='packed';else if(loc.indexOf('delivered')!==-1)targetText='delivered orders';var elements=document.querySelectorAll('*');for(var i=0;i<elements.length;i++){var el=elements[i];if(el.children.length===0&&el.textContent&&el.textContent.trim().toLowerCase()===targetText){var parent=el.parentElement;for(var j=0;j<4;j++){if(parent){var txt=parent.innerText||parent.textContent||'';var nums=txt.match(/\d+/g);if(nums&&nums.length>0){var maxN=0;for(var k=0;k<nums.length;k++){var n=parseInt(nums[k]);if(n>maxN)maxN=n}if(maxN>0){calculatedPages=Math.ceil(maxN/10);break}}parent=parent.parentElement}}break}}if(calculatedPages<1)calculatedPages=1}catch(err){}

  var panel=document.createElement('div');panel.id=PANEL_ID;
  panel.innerHTML=
    '<div class="ali-inner">'+
    '<div style="padding:14px 20px 6px;display:flex;justify-content:space-between;align-items:center">'+
      '<div style="display:flex;align-items:center;gap:10px">'+
        '<div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:15px;color:#fff;font-weight:900;box-shadow:0 3px 12px rgba(99,102,241,0.25)">ğŸ”</div>'+
        '<div><div style="font-size:15px;font-weight:800;color:#1f2937">Ø¨Ø­Ø« Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div><div style="font-size:10px;color:#9ca3af;font-weight:600">v'+VERSION+' â€” iOS Edition</div></div>'+
      '</div>'+
      '<div style="display:flex;gap:6px">'+
        '<button id="ali_min" style="width:26px;height:26px;border-radius:50%;border:none;background:rgba(0,0,0,0.06);color:#9ca3af;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center">âˆ’</button>'+
        '<button id="ali_close" style="width:26px;height:26px;border-radius:50%;border:none;background:rgba(239,68,68,0.08);color:#ef4444;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center">âœ•</button>'+
      '</div>'+
    '</div>'+
    '<div style="padding:10px 16px;overflow-y:auto;max-height:calc(92vh - 60px)" id="ali_body">'+
      '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">'+
        '<div style="background:'+IOS.card+';border-radius:14px;padding:12px 8px;text-align:center;box-shadow:'+IOS.shadow+'"><div style="font-size:18px;margin-bottom:4px">ğŸ“Š</div><div id="stat_total" style="font-size:22px;font-weight:900;color:#8b5cf6">0</div><div style="font-size:9px;color:'+IOS.muted+';font-weight:700">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div></div>'+
        '<div style="background:'+IOS.card+';border-radius:14px;padding:12px 8px;text-align:center;box-shadow:'+IOS.shadow+'"><div style="font-size:18px;margin-bottom:4px">ğŸ”</div><div id="stat_match" style="font-size:22px;font-weight:900;color:#22c55e">0</div><div style="font-size:9px;color:'+IOS.muted+';font-weight:700">Ù…Ø·Ø§Ø¨Ù‚</div></div>'+
        '<div style="background:'+IOS.card+';border-radius:14px;padding:12px 8px;text-align:center;box-shadow:'+IOS.shadow+'"><div style="font-size:18px;margin-bottom:4px">ğŸš€</div><div id="stat_opened" style="font-size:22px;font-weight:900;color:#6366f1">0</div><div style="font-size:9px;color:'+IOS.muted+';font-weight:700">ØªÙ… ÙØªØ­Ù‡</div></div>'+
      '</div>'+
      '<div class="ios-grp" style="padding:14px 16px">'+
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">'+
          '<span style="font-size:13px;font-weight:700">ğŸ“„ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª</span>'+
          '<div style="display:flex;align-items:center;gap:6px"><span style="font-size:11px;color:'+IOS.muted+';font-weight:600">ØµÙØ­Ø©</span><input type="number" id="p_lim" value="'+calculatedPages+'" min="1" class="ios-input" style="width:60px;padding:8px;text-align:center;font-size:15px;font-weight:900;color:'+IOS.accent+'"></div>'+
        '</div>'+
        '<div style="height:6px;background:rgba(0,0,0,0.04);border-radius:6px;overflow:hidden"><div id="p-fill" style="height:100%;width:0%;background:linear-gradient(90deg,#6366f1,#818cf8);border-radius:6px;transition:width 0.8s cubic-bezier(0.16,1,0.3,1)"></div></div>'+
      '</div>'+
      '<div id="status-msg" style="display:flex;align-items:center;gap:8px;padding:12px 16px;border-radius:12px;margin-bottom:12px;font-size:13px;font-weight:700;background:rgba(34,197,94,0.06);color:#22c55e"><span>âœ…</span><span>Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</span></div>'+
      '<div id="ali_dynamic_area"><button id="ali_start" class="ios-btn ios-primary" style="font-size:15px;padding:16px">ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø°ÙƒÙŠ</button></div>'+
      '<div style="text-align:center;padding:12px 0 4px;font-size:9px;color:'+IOS.muted+';font-weight:700;letter-spacing:0.5px">DEVELOPED BY ALI EL-BAZ</div>'+
    '</div></div>';
  document.body.appendChild(panel);

  function setStatus(text,type){var el=document.getElementById('status-msg');if(!el)return;var cf={ready:{color:'#22c55e',bg:'rgba(34,197,94,0.06)',icon:'âœ…'},working:{color:'#6366f1',bg:'rgba(99,102,241,0.06)',icon:'spinner'},error:{color:'#ef4444',bg:'rgba(239,68,68,0.06)',icon:'âŒ'},done:{color:'#22c55e',bg:'rgba(34,197,94,0.06)',icon:'ğŸ‰'},sync:{color:'#f59e0b',bg:'rgba(245,158,11,0.06)',icon:'spinner'}};var c=cf[type]||cf.ready;var ih=c.icon==='spinner'?'<div style="width:14px;height:14px;border:2px solid rgba(99,102,241,0.15);border-top-color:'+IOS.accent+';border-radius:50%;animation:aliSpin 0.8s linear infinite;flex-shrink:0"></div>':'<span>'+c.icon+'</span>';el.style.cssText='display:flex;align-items:center;gap:8px;padding:12px 16px;border-radius:12px;margin-bottom:12px;font-size:13px;font-weight:700;background:'+c.bg+';color:'+c.color+';transition:all 0.3s';el.innerHTML=ih+'<span>'+text+'</span>'}
  function animNum(id,val){var el=document.getElementById(id);if(!el||el.innerText===String(val))return;requestAnimationFrame(function(){el.innerText=val;el.style.animation='aliCountUp 0.4s';setTimeout(function(){el.style.animation=''},400)})}
  function updateStats(mc){animNum('stat_total',state.savedRows.length);animNum('stat_match',mc!==undefined?mc:state.savedRows.length);animNum('stat_opened',state.openedCount)}
  function debounce(fn,d){var t;return function(){clearTimeout(t);t=setTimeout(fn,d)}}
  function getCurrentStatus(){var s='readypack';var l=window.location.href.toLowerCase();if(l.indexOf('new')!==-1)s='new';else if(l.indexOf('packed')!==-1&&l.indexOf('ready')===-1)s='packed';else if(l.indexOf('delivered')!==-1)s='delivered';return s}

  panel.addEventListener('click',function(e){if(panel.classList.contains('ali-minimized')){panel.classList.remove('ali-minimized');e.stopPropagation()}});
  document.getElementById('ali_close').addEventListener('click',function(e){e.stopPropagation();panel.style.transition='all 0.3s';panel.style.opacity='0';panel.style.transform='translateX(40px) scale(0.97)';setTimeout(function(){panel.remove()},300)});
  document.getElementById('ali_min').addEventListener('click',function(e){e.stopPropagation();panel.classList.add('ali-minimized')});

  function createSafeLabel(inv,args){var label=document.createElement('label');label.style.cssText='cursor:pointer;color:'+IOS.accent+';text-decoration:underline;font-weight:bold';label.textContent=inv;if(args){label.addEventListener('click',function(){getDetails(args[0],args[1],args[2],args[3])})}return label}
  async function fetchPageOrders(pn,cs){var bu=window.location.origin+"/ez_pill_web/";var res=await fetch(bu+'Home/getOrders',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:cs,pageSelected:pn,searchby:''})});return await res.json()}
  function buildOrderRow(item,tpl){var inv=item.Invoice||'';var onl=item.onlineNumber||'';var ty=item.typee!==undefined?item.typee:'';var hid=item.head_id!==undefined?item.head_id:'';var args=null;if(onl!==''&&inv!=='')args=[onl.replace(/ERX/gi,''),inv,ty,hid];var cl;if(tpl){cl=tpl.cloneNode(true);var cs=cl.querySelectorAll('td');if(cs.length>3){cs[0].innerHTML='';cs[0].appendChild(createSafeLabel(inv,args));cs[1].textContent=onl;cs[2].textContent=item.guestName||'';cs[3].textContent=item.guestMobile||item.mobile||''}}else{cl=document.createElement('tr');var t0=document.createElement('td'),t1=document.createElement('td'),t2=document.createElement('td'),t3=document.createElement('td');t0.appendChild(createSafeLabel(inv,args));t1.textContent=onl;t2.textContent=item.guestName||'';t3.textContent=item.guestMobile||item.mobile||'';cl.appendChild(t0);cl.appendChild(t1);cl.appendChild(t2);cl.appendChild(t3)}return{id:inv,onl:onl,node:cl,args:args,hasArgs:args!==null}}

  var totalNoArgs=0;
  async function scanPage(isSync){state.isProcessing=true;var fill=document.getElementById('p-fill');var cs=getCurrentStatus();try{setStatus(isSync?'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...':'Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„ØµÙØ­Ø§Øª...',isSync?'sync':'working');var mp=parseInt(document.getElementById('p_lim').value)||1;var tables=document.querySelectorAll('table');var tt=tables[0];for(var t=0;t<tables.length;t++){if(tables[t].innerText.length>tt.innerText.length)tt=tables[t]}var tbody=tt.querySelector('tbody')||tt;var tpl=tbody.querySelector('tr');var ce=0;for(var pg=1;pg<=mp;pg++){if(fill)fill.style.width=((pg/mp)*100)+'%';setStatus((isSync?'Ù…Ø²Ø§Ù…Ù†Ø©':'ØªØ­Ù„ÙŠÙ„')+' Ø§Ù„ØµÙØ­Ø© '+pg+' Ù…Ù† '+mp+' ...',isSync?'sync':'working');var data=await fetchPageOrders(pg,cs);if(pg===1&&data.total_orders){var et=parseInt(data.total_orders)||0;if(et>0){mp=Math.ceil(et/10);document.getElementById('p_lim').value=mp}}var orders=[];try{orders=typeof data.orders_list==='string'?JSON.parse(data.orders_list):data.orders_list}catch(e){}if(!orders||orders.length===0){ce++;if(ce>=2)break;continue}else ce=0;var nac=0;for(var i=0;i<orders.length;i++){var inv=orders[i].Invoice||'';if(inv.length>3&&!state.visitedSet.has(inv)){state.visitedSet.add(inv);var rd=buildOrderRow(orders[i],tpl);if(!rd.hasArgs)nac++;state.savedRows.push(rd)}}totalNoArgs+=nac;updateStats()}finishScan(isSync)}catch(err){console.error(err);setStatus('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…','error');showToast('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø³Ø­Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!','error');state.isProcessing=false;state.isSyncing=false}}

  async function smartSync(){state.isSyncing=true;state.isProcessing=true;var fill=document.getElementById('p-fill');var cs=getCurrentStatus();try{setStatus('Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø©...','sync');var so=new Map();var mp=parseInt(document.getElementById('p_lim').value)||1;var ce=0;var fd=await fetchPageOrders(1,cs);if(fd.total_orders){var et=parseInt(fd.total_orders)||0;if(et>0){mp=Math.ceil(et/10);document.getElementById('p_lim').value=mp}}var fo=[];try{fo=typeof fd.orders_list==='string'?JSON.parse(fd.orders_list):fd.orders_list}catch(e){}if(fo&&fo.length>0){for(var fi=0;fi<fo.length;fi++){var fI=fo[fi].Invoice||'';if(fI.length>3)so.set(fI,fo[fi])}}if(fill)fill.style.width=((1/mp)*100)+'%';for(var pg=2;pg<=mp;pg++){if(fill)fill.style.width=((pg/mp)*100)+'%';setStatus('Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØµÙØ­Ø© '+pg+' Ù…Ù† '+mp+'...','sync');var data=await fetchPageOrders(pg,cs);var orders=[];try{orders=typeof data.orders_list==='string'?JSON.parse(data.orders_list):data.orders_list}catch(e){}if(!orders||orders.length===0){ce++;if(ce>=2)break;continue}else ce=0;for(var oi=0;oi<orders.length;oi++){var oI=orders[oi].Invoice||'';if(oI.length>3)so.set(oI,orders[oi])}}setStatus('Ø¬Ø§Ø±ÙŠ Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...','sync');var oldIds=new Set(state.savedRows.map(function(r){return r.id}));var remIds=[];var kept=[];for(var ri=0;ri<state.savedRows.length;ri++){if(so.has(state.savedRows[ri].id))kept.push(state.savedRows[ri]);else remIds.push(state.savedRows[ri].id)}var tables=document.querySelectorAll('table');var tt=tables[0];for(var t=0;t<tables.length;t++){if(tables[t].innerText.length>tt.innerText.length)tt=tables[t]}var tbody=tt.querySelector('tbody')||tt;var tpl=tbody.querySelector('tr');var newR=[];var nan=0;so.forEach(function(item,inv){if(!oldIds.has(inv)){var rd=buildOrderRow(item,tpl);if(!rd.hasArgs)nan++;newR.push(rd)}});state.savedRows=kept.concat(newR);state.visitedSet.clear();for(var si=0;si<state.savedRows.length;si++)state.visitedSet.add(state.savedRows[si].id);state.tbody=tbody;state.tbody.innerHTML='';for(var di=0;di<state.savedRows.length;di++){state.savedRows[di].node.style.cursor='pointer';state.tbody.appendChild(state.savedRows[di].node)}updateStats(state.savedRows.length);var sp=[];if(remIds.length>0)sp.push('ğŸ—‘ '+remIds.length+' ØªÙ… Ø¥Ø²Ø§Ù„ØªÙ‡');if(newR.length>0)sp.push('âœ¨ '+newR.length+' Ø¬Ø¯ÙŠØ¯');if(remIds.length===0&&newR.length===0)sp.push('Ù„Ø§ ØªØºÙŠÙŠØ±Ø§Øª');var st=sp.join(' | ')+' â€” Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: '+state.savedRows.length;setStatus('ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© â€” '+st,'done');if(nan>0)showToast(nan+' Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ø¨Ø¯ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª ÙØªØ­','warning');await showDialog({icon:'âœ…',title:'ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­',desc:'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø£Ø­Ø¯Ø« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…',badges:[{text:'ğŸ—‘ Ø­ÙØ°Ù '+remIds.length,active:remIds.length>0},{text:'âœ¨ Ø¬Ø¯ÙŠØ¯ '+newR.length,active:newR.length>0},{text:'ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ '+state.savedRows.length,active:true}],info:[{label:'ØªÙ… Ø¥Ø²Ø§Ù„ØªÙ‡',value:remIds.length.toString(),color:remIds.length>0?'#ef4444':'#9ca3af'},{label:'Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©',value:newR.length.toString(),color:newR.length>0?'#22c55e':'#9ca3af'},{label:'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',value:state.savedRows.length.toString(),color:'#6366f1'}],buttons:[{text:'Ø¥Ù„ØºØ§Ø¡',value:'cancel',primary:false},{text:'ğŸ‘ ØªÙ…Ø§Ù…',value:'ok',primary:true}]});showToast(st,'success')}catch(err){console.error('Sync error:',err);setStatus('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© â€” Ø­Ø§ÙˆÙ„ ØªØ§Ù†ÙŠ','error');showToast('ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: '+(err.message||'Ø®Ø·Ø£'),'error')}finally{state.isSyncing=false;state.isProcessing=false;var sb=document.getElementById('ali_btn_sync');if(sb){sb.disabled=false;sb.innerHTML='ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø© Ø°ÙƒÙŠØ©';sb.className='ios-btn ios-ghost'}}}

  function finishScan(isSync){state.isProcessing=false;state.isSyncing=false;var tables=document.querySelectorAll('table');var tt=tables[0];for(var t=0;t<tables.length;t++){if(tables[t].innerText.length>tt.innerText.length)tt=tables[t]}state.tbody=tt.querySelector('tbody')||tt;state.tbody.innerHTML='';for(var i=0;i<state.savedRows.length;i++){state.savedRows[i].node.style.cursor='pointer';state.tbody.appendChild(state.savedRows[i].node)}updateStats(state.savedRows.length);if(totalNoArgs>0)showToast(totalNoArgs+' Ø·Ù„Ø¨ Ø¨Ø¯ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª ÙØªØ­','warning');if(isSync){setStatus('ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© â€” '+state.savedRows.length+' Ø·Ù„Ø¨','done');showToast('ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: '+state.savedRows.length+' Ø·Ù„Ø¨','success')}else{setStatus('ØªÙ… Ø§Ù„ØªØ¬Ù…ÙŠØ¹ â€” '+state.savedRows.length+' Ø·Ù„Ø¨ Ø¬Ø§Ù‡Ø²','done');showToast('ØªÙ… ØªØ¬Ù…ÙŠØ¹ '+state.savedRows.length+' Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­','success')}buildSearchUI()}

  function buildSearchUI(){var da=document.getElementById('ali_dynamic_area');
    da.innerHTML='<div class="ios-grp" style="padding:14px 16px"><div style="position:relative;margin-bottom:8px"><span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:15px;font-weight:900;color:'+IOS.muted+';pointer-events:none;font-family:monospace">0</span><input type="text" id="ali_sI" class="ios-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨Ø¹Ø¯ Ø§Ù„Ù€ 0..." style="padding-left:30px;direction:ltr;text-align:left;letter-spacing:1px;font-family:monospace;font-weight:700"></div><div style="position:relative"><span style="position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:13px;pointer-events:none">ğŸ”—</span><input type="text" id="ali_sO" class="ios-input" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ (ERX)..." style="padding-right:36px;direction:rtl"></div></div><div id="ali_search_count" style="font-size:11px;color:'+IOS.muted+';text-align:center;font-weight:600;padding:2px 0 10px">Ø¹Ø±Ø¶ '+state.savedRows.length+' Ù…Ù† '+state.savedRows.length+' Ù†ØªÙŠØ¬Ø©</div><button id="ali_btn_open" class="ios-btn ios-success" style="margin-bottom:8px;opacity:0.7;cursor:not-allowed">âš¡ Ø§Ø¨Ø­Ø« Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§ÙØªØ­ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚</button><button id="ali_btn_sync" class="ios-btn ios-ghost">ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø© Ø°ÙƒÙŠØ©</button>';
    var sI=document.getElementById('ali_sI'),sO=document.getElementById('ali_sO'),sc=document.getElementById('ali_search_count'),ob=document.getElementById('ali_btn_open'),cm=[];
    function fr(){var ri=sI.value.trim();var is=ri!==''?'0'+ri:'';var os=sO.value.trim().toLowerCase();state.tbody.innerHTML='';var sh=0;cm=[];var hf=is!==''||os!=='';for(var i=0;i<state.savedRows.length;i++){var rw=state.savedRows[i];var mi=is!==''&&rw.id.startsWith(is);var mo=os!==''&&rw.onl.toLowerCase().indexOf(os)!==-1;var s=hf?(mi||mo):true;if(s){state.tbody.appendChild(rw.node);sh++;if(hf)cm.push(rw)}}sc.innerText='Ø¹Ø±Ø¶ '+sh+' Ù…Ù† '+state.savedRows.length+' Ù†ØªÙŠØ¬Ø©';updateStats(sh);if(hf&&cm.length>0){var op=cm.filter(function(r){return r.args!==null}).length;ob.innerHTML='âš¡ ÙØªØ­ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ ('+op+' Ø·Ù„Ø¨)';ob.style.opacity='1';ob.style.cursor='pointer'}else if(hf&&cm.length===0){ob.innerHTML='âš¡ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬';ob.style.opacity='0.5';ob.style.cursor='not-allowed'}else{ob.innerHTML='âš¡ Ø§Ø¨Ø­Ø« Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§ÙØªØ­ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚';ob.style.opacity='0.7';ob.style.cursor='not-allowed'}sI.className='ios-input'+(ri.length>0?(sh>0?' match':' nomatch'):'');sO.className='ios-input'+(os.length>0?(sh>0?' match':' nomatch'):'')}
    var df=debounce(fr,150);sI.addEventListener('input',df);sO.addEventListener('input',df);
    ob.addEventListener('click',async function(){var ri=sI.value.trim();var os=sO.value.trim().toLowerCase();var hf=ri!==''||os!=='';if(!hf){showToast('Ø§Ø¨Ø­Ø« Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨!','warning');sI.focus();sI.style.animation='aliBlink 0.5s 3';setTimeout(function(){sI.style.animation=''},1500);return}var op=cm.filter(function(r){return r.args!==null});var sk=cm.length-op.length;if(op.length===0){showToast(sk>0?sk+' Ø·Ù„Ø¨ Ù…Ø·Ø§Ø¨Ù‚ Ù„ÙƒÙ† Ø¨Ø¯ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª ÙØªØ­!':'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©!',sk>0?'error':'warning');return}if(sk>0)showToast('âš ï¸ ØªÙ… ØªØ®Ø·ÙŠ '+sk+' Ø·Ù„Ø¨ Ø¨Ø¯ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª ÙØªØ­','warning');ob.disabled=true;ob.style.opacity='0.6';ob.style.cursor='not-allowed';var opened=0,failed=0;var base=window.location.origin+"/ez_pill_web/getEZPill_Details";for(var idx=0;idx<op.length;idx++){var it=op[idx];var url=base+"?onlineNumber="+encodeURIComponent(it.args[0])+"&Invoice="+encodeURIComponent(it.args[1])+"&typee="+encodeURIComponent(it.args[2])+"&head_id="+encodeURIComponent(it.args[3]);try{var w=window.open(url,"_blank");if(w){opened++;state.openedCount++;window.focus();try{w.blur()}catch(e){}}else failed++}catch(e){failed++}ob.innerHTML='ğŸš€ Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØªØ­ ('+(idx+1)+'/'+op.length+')';setStatus('ÙØªØ­ '+(idx+1)+' Ù…Ù† '+op.length+': '+(it.onl||it.id),'working');updateStats();if(idx<op.length-1)await new Promise(function(r){setTimeout(r,1200)})}showToast('ØªÙ… ÙØªØ­ '+opened+' Ø·Ù„Ø¨ (ÙØ´Ù„ '+failed+')',opened>0?'success':'error');setStatus('ØªÙ… ÙØªØ­ '+opened+' â€” Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: '+state.openedCount,'done');ob.disabled=false;ob.innerHTML='âš¡ ÙØªØ­ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ ('+op.length+' Ø·Ù„Ø¨)';fr()});
    document.getElementById('ali_btn_sync').addEventListener('click',async function(){if(state.isSyncing||state.isProcessing){showToast('Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø´ØºØ§Ù„Ø© â€” Ø§Ù†ØªØ¸Ø±!','warning');return}var sb=this;var oc=state.savedRows.length;var result=await showDialog({icon:'ğŸ”„',title:'Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø°ÙƒÙŠØ©',desc:'Ù‡ÙŠØªÙ… Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù…',badges:[{text:'Ø­Ø°Ù Ø§Ù„Ù…ÙØºÙ„Ù‚',active:true},{text:'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯',active:true},{text:'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',active:true}],info:[{label:'Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©',value:oc.toString(),color:'#6366f1'},{label:'Ø§Ù„Ø¹Ù…Ù„ÙŠØ©',value:'Ù…Ù‚Ø§Ø±Ù†Ø© + ØªØ­Ø¯ÙŠØ«',color:'#3b82f6'}],buttons:[{text:'Ø¥Ù„ØºØ§Ø¡',value:'cancel',primary:false},{text:'ğŸ”„ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©',value:'confirm',primary:true}]});if(result!=='confirm')return;sb.disabled=true;sb.innerHTML='<div style="width:14px;height:14px;border:2px solid rgba(99,102,241,0.15);border-top-color:#6366f1;border-radius:50%;animation:aliSpin 0.8s linear infinite"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...';sb.style.color=IOS.accent;await smartSync();buildSearchUI()})}

  document.getElementById('ali_start').addEventListener('click',function(){if(state.isProcessing)return;this.disabled=true;this.innerHTML='<div style="width:14px;height:14px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:aliSpin 0.8s linear infinite"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...';this.style.opacity='0.7';this.style.cursor='not-allowed';totalNoArgs=0;scanPage(false)});
})();
